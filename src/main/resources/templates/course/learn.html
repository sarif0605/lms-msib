<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
    th:replace="~{layout :: layout(~{::title}, ~{::section})}">

<head>
    <title th:text="'Learning: ' + ${course.title} + ' - LMSHub'">Learning View</title>
</head>

<body>
    <section>
        <div class="container-fluid px-lg-5 py-4">
            <div class="row g-4">
                <!-- Main Content Area -->
                <div class="col-lg-8 animate__animated animate__fadeIn">
                    <div th:if="${currentChapter != null}">
                        <div class="d-flex align-items-center justify-content-between mb-4">
                            <div>
                                <h6 class="text-primary fw-bold small uppercase tracking-wider mb-1">Current Chapter
                                </h6>
                                <h2 class="fw-bold mb-0" th:text="${currentChapter.title}">Chapter Title</h2>
                            </div>
                            <div class="d-flex align-items-center gap-3">
                                <span class="badge bg-light text-dark border rounded-pill px-3 py-2 fw-medium">
                                    <i class="bi bi-clock me-2"></i>12m left
                                </span>
                            </div>
                        </div>

                        <!-- Video Player -->
                        <div th:if="${currentChapter.videoUrl}"
                            class="ratio ratio-16x9 mb-5 rounded-5 shadow-2xl overflow-hidden border bg-black">
                            <iframe th:src="${currentChapter.videoUrl}" allowfullscreen></iframe>
                        </div>

                        <!-- Content Tabs -->
                        <div class="card border-0 shadow-sm rounded-5 overflow-hidden mb-5">
                            <div class="card-header bg-white border-0 px-4 pt-4">
                                <ul class="nav nav-pills gap-2" id="learnTab" role="tablist">
                                    <li class="nav-item">
                                        <button class="nav-link active rounded-pill px-4 fw-bold" data-bs-toggle="tab"
                                            data-bs-target="#overview">Overview</button>
                                    </li>
                                    <li th:if="${currentChapter.assignment}" class="nav-item">
                                        <button class="nav-link rounded-pill px-4 fw-bold" data-bs-toggle="tab"
                                            data-bs-target="#assignment">Assignment</button>
                                    </li>
                                    <li th:if="${currentChapter.quiz}" class="nav-item">
                                        <button class="nav-link rounded-pill px-4 fw-bold" data-bs-toggle="tab"
                                            data-bs-target="#quiz">Quiz</button>
                                    </li>
                                </ul>
                            </div>
                            <div class="card-body p-4 p-lg-5">
                                <div class="tab-content">
                                    <div class="tab-pane fade show active" id="overview">
                                        <div class="content-text lead text-secondary" style="line-height: 1.8;"
                                            th:text="${currentChapter.content}">
                                            Chapter Content goes here...
                                        </div>
                                    </div>
                                    <div th:if="${currentChapter.assignment}" class="tab-pane fade" id="assignment">
                                        <div class="p-4 rounded-4 bg-primary-subtle border border-primary-subtle">
                                            <h5 class="fw-bold text-primary mb-3"><i
                                                    class="bi bi-pencil-square me-2"></i>Assignment Instructions</h5>
                                            <p class="text-secondary mb-0" th:text="${currentChapter.assignment}"></p>
                                        </div>
                                    </div>
                                    <div th:if="${currentChapter.quiz}" class="tab-pane fade" id="quiz">
                                        <div class="text-center py-4">
                                            <div class="bg-info-subtle text-info rounded-circle d-inline-flex align-items-center justify-content-center mb-4"
                                                style="width: 80px; height: 80px;">
                                                <i class="bi bi-patch-question fs-1"></i>
                                            </div>
                                            <h4 class="fw-bold">Ready for a challenge?</h4>
                                            <p class="text-muted mb-4">Test your knowledge on this chapter's topics.</p>
                                            <a th:href="@{'/quizzes/' + ${currentChapter.quiz.id}}"
                                                class="btn btn-info text-white rounded-pill px-5 py-3 fw-bold">
                                                Start Quiz Now <i class="bi bi-arrow-right ms-2"></i>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div
                                class="card-footer bg-white border-0 p-4 pt-0 d-flex justify-content-between align-items-center">
                                <button class="btn btn-outline-dark rounded-pill px-4 fw-bold disabled">
                                    <i class="bi bi-chevron-left me-2"></i>Previous
                                </button>
                                <form th:action="@{'/chapters/' + ${currentChapter.id} + '/complete'}" method="post">
                                    <button type="submit"
                                        class="btn btn-success rounded-pill px-5 py-3 fw-bold shadow-glow">
                                        Complete & Continue <i class="bi bi-chevron-right ms-2"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- End of Course / Review Section -->
                    <div th:if="${isCompleted}" class="animate__animated animate__fadeInUp">
                        <div
                            class="card border-0 bg-primary text-white shadow-glow p-5 rounded-5 mb-5 text-center overflow-hidden position-relative">
                            <div class="position-absolute top-0 start-0 w-100 h-100 opacity-10"
                                style="background-image: url('https://www.transparenttextures.com/patterns/cubes.png');">
                            </div>
                            <div class="position-relative z-1">
                                <div class="bg-white text-primary rounded-circle d-inline-flex align-items-center justify-content-center mb-4 shadow-lg"
                                    style="width: 80px; height: 80px;">
                                    <i class="bi bi-trophy-fill fs-1"></i>
                                </div>
                                <h1 class="display-5 fw-bold mb-3">Congratulations!</h1>
                                <p class="lead mb-5 opacity-75">You've successfully completed <strong
                                        th:text="${course.title}">this course</strong>.</p>
                                <div class="d-flex justify-content-center gap-3">
                                    <button
                                        class="btn btn-white rounded-pill px-5 py-3 fw-bold bg-white text-primary">Claim
                                        Certificate</button>
                                    <a href="#reviewArea"
                                        class="btn btn-outline-light rounded-pill px-5 py-3 fw-bold">Leave a Review</a>
                                </div>
                            </div>
                        </div>

                        <div id="reviewArea" class="card border-0 shadow-sm rounded-5 overflow-hidden">
                            <div class="card-body p-4 p-lg-5">
                                <h3 class="fw-bold mb-4">Share Your Experience</h3>
                                <form th:action="@{'/courses/' + ${course.id} + '/reviews'}" method="post">
                                    <div class="mb-4">
                                        <label
                                            class="form-label small fw-bold text-muted uppercase tracking-wider">Overall
                                            Rating</label>
                                        <select name="rating"
                                            class="form-select bg-light border-0 py-3 rounded-4 fw-bold" required>
                                            <option value="5">⭐⭐⭐⭐⭐ Excellent - Loved it!</option>
                                            <option value="4">⭐⭐⭐⭐ Very Good - Learned a lot</option>
                                            <option value="3">⭐⭐⭐ Good - Solid content</option>
                                            <option value="2">⭐⭐ Fair - Could be better</option>
                                            <option value="1">⭐ Poor - Disappointed</option>
                                        </select>
                                    </div>
                                    <div class="mb-4">
                                        <label class="form-label small fw-bold text-muted uppercase tracking-wider">Your
                                            Detailed Review</label>
                                        <textarea name="comment" class="form-control bg-light border-0 rounded-4 p-4"
                                            rows="5"
                                            placeholder="Tell other students what you thought about this course..."
                                            required></textarea>
                                    </div>
                                    <button type="submit"
                                        class="btn btn-primary w-100 py-3 rounded-4 fw-bold shadow-lg shadow-glow-primary">
                                        Post My Review <i class="bi bi-send ms-2"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Course Progress Sidebar -->
                <div class="col-lg-4 animate__animated animate__fadeInRight">
                    <div class="card border-0 shadow-sm rounded-5 overflow-hidden sticky-top" style="top: 100px;">
                        <div class="card-header bg-white border-0 p-4 pb-0">
                            <h5 class="fw-bold mb-3">Course Content</h5>
                            <div class="progress rounded-pill mb-2" style="height: 8px;">
                                <div class="progress-bar bg-primary" role="progressbar"
                                    th:style="'width: ' + ${enrollment != null ? enrollment.progressPercentage : 0} + '%'"
                                    th:attr="aria-valuenow=${enrollment != null ? enrollment.progressPercentage : 0}"
                                    aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <div class="d-flex justify-content-between small text-muted mb-3">
                                <span
                                    th:text="${enrollment != null ? #numbers.formatDecimal(enrollment.progressPercentage, 0, 0) : 0} + '% Complete'">0%
                                    Complete</span>
                                <span>2 / 12 Chapters</span>
                            </div>
                        </div>
                        <div class="card-body p-3 overflow-auto" style="max-height: 60vh;">
                            <div class="list-group list-group-flush gap-2">
                                <div th:each="chapter, iter : ${course.chapters}" class="border-0">
                                    <a th:href="@{'/courses/' + ${course.id} + '/learn?chapterId=' + ${chapter.id}}"
                                        class="list-group-item list-group-item-action rounded-4 border-0 p-3 d-flex align-items-center justify-content-between transition-all"
                                        th:classappend="${currentChapter != null && currentChapter.id == chapter.id ? 'bg-primary-subtle active-chapter shadow-sm' : ''}">
                                        <div class="d-flex align-items-center gap-3">
                                            <div class="chapter-status rounded-circle d-flex align-items-center justify-content-center"
                                                style="width: 28px; height: 28px; font-weight: 700; font-size: 0.7rem;"
                                                th:with="prog=${chapterProgress != null ? chapterProgress.?[chapter.id == __${chapter.id}__] : null}"
                                                th:classappend="${prog != null && !#lists.isEmpty(prog) && prog[0].isCompleted ? 'bg-success text-white' : (currentChapter != null && currentChapter.id == chapter.id ? 'bg-primary text-white' : 'bg-light text-muted')}"
                                                th:text="${prog != null && !#lists.isEmpty(prog) && prog[0].isCompleted} ? '' : ${iter.index + 1}">
                                                <i th:if="${prog != null && !#lists.isEmpty(prog) && prog[0].isCompleted}"
                                                    class="bi bi-check-lg"></i>
                                            </div>
                                            <div class="small fw-bold text-truncate" style="max-width: 180px;"
                                                th:text="${chapter.title}">Chapter Title</div>
                                        </div>
                                        <span class="smallest text-muted">12:30</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <style>
            .shadow-2xl {
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            }

            .shadow-glow {
                box-shadow: 0 10px 30px -5px rgba(25, 135, 84, 0.4);
            }

            .shadow-glow-primary {
                box-shadow: 0 10px 30px -5px rgba(78, 115, 223, 0.4);
            }

            .uppercase {
                text-transform: uppercase;
            }

            .tracking-wider {
                letter-spacing: 0.1em;
            }

            .smallest {
                font-size: 0.65rem;
            }

            .active-chapter {
                border-left: 4px solid var(--bs-primary) !important;
                color: var(--bs-primary) !important;
            }

            .transition-all {
                transition: all 0.2s ease;
            }

            .nav-pills .nav-link.active {
                background-color: var(--bs-primary);
            }

            .bg-primary {
                background: linear-gradient(135deg, #4e73df 0%, #224abe 100%) !important;
            }
        </style>
    </section>
</body>

</html>